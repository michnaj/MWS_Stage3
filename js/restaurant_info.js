const systemMsg=document.getElementById("system_messages"),systemMsgTime=1e4;function hideSystemMessages(){systemMsg.setAttribute("aria-live","off"),systemMsg.classList.remove("open"),document.getElementById("system_messages-text").innerHTML=""}function showMessage(e){console.log("Showing message");let t=document.getElementById("system_messages-text"),n=document.getElementById("system_messages-container");switch(n.classList.remove("error","info","success","warning"),e){case"invalid":t.innerHTML="Incorrect data in the form. Check data and try again.",n.classList.add("error");break;case"saved":t.innerHTML="Review saved. Thank you for your opinion.",n.classList.add("success");break;default:t.innerHTML="Something went wrong! Try again, please.",n.classList.add("info")}systemMsg.setAttribute("aria-live","assertive"),systemMsg.classList.add("open"),setTimeout(hideSystemMessages,systemMsgTime)}let restaurant,restaurantId,reviews;var map;document.getElementById("system_msg-close-button").addEventListener("click",e=>{e.preventDefault(),systemMsg.classList.remove("open"),systemMsg.setAttribute("aria-live","off")});const nameField=document.getElementById("name-input"),ratingField=document.getElementById("rating-select"),commentField=document.getElementById("comment-textarea"),nameMsg=document.getElementById("name-message"),ratingMsg=document.getElementById("rating-message"),commentMsg=document.getElementById("comment-message"),reviewForm=document.getElementById("review_form"),reviewSaveButton=document.getElementById("review_form-save"),reviewClearButton=document.getElementById("review_form-clear"),favoriteButton=document.getElementById("restaurant-favorite");function saveReview(e){console.log(`Review saved: ${e}`),showMessage("saved"),reviewForm.classList.remove("open")}function checkValidText(e){return!(!e||0==e.trim().length||e.match(/(<([^>]+)>)/gi)||e.match("&lt;")||e.match("&gt;")||e.match("&amp;")||e.match("&quot;"))}function checkValidRating(e){return!!e}function setFieldsAttribute(e,t){switch(t){case"name":nameField.setAttribute("aria-invalid",e),e?(nameMsg.setAttribute("aria-live","assertive"),nameMsg.style.visibility="visible"):(nameMsg.setAttribute("aria-live","off"),nameMsg.style.visibility="hidden");break;case"rating":ratingField.setAttribute("aria-invalid",e),e?(ratingMsg.setAttribute("aria-live","assertive"),ratingMsg.style.visibility="visible"):(ratingMsg.setAttribute("aria-live","off"),ratingMsg.style.visibility="hidden");break;case"comment":commentField.setAttribute("aria-invalid",e),e?(commentMsg.setAttribute("aria-live","assertive"),commentMsg.style.visibility="visible"):(commentMsg.setAttribute("aria-live","off"),commentMsg.style.visibility="hidden");break;default:return}}function validateReviewForm(e){let t=!0;return checkValidRating(e.rating)?setFieldsAttribute(!1,"rating"):(setFieldsAttribute(!0,"rating"),t=!1),checkValidText(e.name)?setFieldsAttribute(!1,"name"):(setFieldsAttribute(!0,"name"),t=!1),checkValidText(e.comment)?setFieldsAttribute(!1,"comment"):(setFieldsAttribute(!0,"comment"),t=!1),t}window.initMap=(()=>{fetchRestaurantFromURL((e,t)=>{e?console.error(e):(self.map=new google.maps.Map(document.getElementById("map"),{zoom:17,center:t.latlng,scrollwheel:!1}),fillBreadcrumb(),DBHelper.mapMarkerForRestaurant(self.restaurant,self.map))})}),fetchRestaurantFromURL=(e=>{if(self.restaurant)return void e(null,self.restaurant);const t=getParameterByName("id");t?DBHelper.fetchRestaurantById(t,(t,n)=>{self.restaurant=n,n?(fillRestaurantHTML(),e(null,n)):console.error(t)}):(error="No restaurant id in URL",e(error,null))}),fillRestaurantHTML=((e=self.restaurant)=>{document.getElementById("restaurant-name").innerHTML=e.name,document.getElementById("restaurant-address").innerHTML=e.address;const t=document.getElementById("restaurant-img");t.className="restaurant-img";let n=document.createElement("source"),a=document.createElement("source"),i=document.createElement("img");n.setAttribute("media","(max-width: 380px)"),n.setAttribute("srcset",DBHelper.imageUrlForRestaurant(e,"sm")),a.setAttribute("media","(max-width: 575px)"),a.setAttribute("srcset",DBHelper.imageUrlForRestaurant(e,"md")),i.setAttribute("alt",DBHelper.imageAltAttribute(e)),i.src=DBHelper.imageUrlForRestaurant(e,""),t.appendChild(n),t.appendChild(a),t.appendChild(i),document.getElementById("restaurant-cuisine").innerHTML=e.cuisine_type,e.operating_hours&&fillRestaurantHoursHTML(),fillReviewsHTML()}),fillRestaurantHoursHTML=((e=self.restaurant.operating_hours)=>{const t=document.getElementById("restaurant-hours");for(let n in e){const a=document.createElement("tr");a.tabIndex=0;const i=document.createElement("td");i.innerHTML=n,a.appendChild(i);const s=document.createElement("td");s.innerHTML=e[n],a.appendChild(s),t.appendChild(a)}}),fillReviewsHTML=((e=self.restaurant.id)=>{DBHelper.fetchReviews(e,(e,t)=>{if(e)console.log(e);else{const e=document.getElementById("reviews-container");if(!t){const t=document.createElement("p");return t.innerHTML="No reviews yet!",void e.appendChild(t)}{const n=document.getElementById("reviews-list");n.innerHTML="",t.forEach(e=>{n.appendChild(createReviewHTML(e))}),e.appendChild(n)}}})}),createReviewHTML=(e=>{const t=document.createElement("li"),n=document.createElement("p");n.classList.add("name"),n.innerHTML=e.name,t.appendChild(n);const a=document.createElement("p");a.classList.add("date");let i=formatDate(new Date(e.createdAt));a.innerHTML=i,t.appendChild(a);const s=document.createElement("p");s.classList.add("rating"),s.innerHTML=`Rating: ${e.rating}`,t.appendChild(s);const r=document.createElement("p");return r.classList.add("comment"),r.innerHTML=e.comments,t.appendChild(r),t}),formatDate=(e=>{let t=e.getDate(),n=e.getMonth(),a=e.getFullYear();return`${["January","February","March","April","May","June","July","August","September","October","November","December"][n]} ${t}, ${a}`}),fillBreadcrumb=((e=self.restaurant)=>{const t=document.getElementById("breadcrumb"),n=document.createElement("li"),a=document.createElement("a");a.innerHTML=e.name,a.href=DBHelper.urlForRestaurant(e),a.setAttribute("aria-current","page"),n.append(a),t.appendChild(n)}),getParameterByName=((e,t)=>{t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");const n=new RegExp(`[?&]${e}(=([^&#]*)|&|#|$)`).exec(t);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null}),favoriteButton.addEventListener("click",e=>{e.preventDefault(),favoriteButton.classList.toggle("favorite")}),document.addEventListener("DOMContentLoaded",e=>{document.getElementById("restaurant-id-input").value=getParameterByName("id")}),document.getElementById("review_form-add").addEventListener("click",e=>{e.preventDefault(),reviewForm.classList.toggle("open")}),reviewSaveButton.addEventListener("click",e=>{e.preventDefault();let t={restaurantId:document.getElementById("restaurant-id-input").value,name:document.getElementById("name-input").value,rating:document.getElementById("rating-select").value,comment:document.getElementById("comment-textarea").value};validateReviewForm(t)?saveReview(t):showMessage("invalid")}),reviewClearButton.addEventListener("click",e=>{e.preventDefault(),nameField.value="",nameField.setAttribute("aria-invalid",""),nameMsg.style.visibility="hidden",nameMsg.setAttribute("aria-live","off"),ratingField.value="",ratingField.setAttribute("aria-invalid",""),ratingMsg.style.visibility="hidden",ratingMsg.setAttribute("aria-live","off"),commentField.value="",commentField.setAttribute("aria-invalid",""),commentMsg.style.visibility="hidden",commentMsg.setAttribute("aria-live","off"),hideSystemMessages()}),nameField.addEventListener("focusout",e=>{setFieldsAttribute(!checkValidText(nameField.value),"name")}),ratingField.addEventListener("focusout",e=>{setFieldsAttribute(!checkValidRating(ratingField.value),"rating")}),commentField.addEventListener("focusout",e=>{setFieldsAttribute(!checkValidText(commentField.value),"comment")});